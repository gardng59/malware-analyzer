#include <stdio.h>
#include <stdlib.h>
#include <iostream>
#include <fstream>
#include <string.h>
#include "common.h"

int main(int argc, char **argv)
{
	std::string command(argv[1]);
	command = "readpe --format csv -i " + command;
	const char* c_str_command = command.c_str();

	FILE *result;
	char buffer[255];
	result = popen(c_str_command, "r");

	std::string current_library;

	while(fgets(buffer, 255, result) != NULL)
	{
		if(strncmp(buffer, "Library", 7) == 0)
		{
			if(fgets(buffer, 255, result) != NULL)
			{
				current_library = buffer;
				std::size_t end_pos = current_library.find(".") - 5;
				current_library = current_library.substr(5, end_pos);
			}
		}
		else if(strncmp(buffer, "Functions", 9) == 0)
		{
			continue;
		}
		else if(strncmp(buffer, "Function", 8) == 0)
		{
			if(fgets(buffer, 255, result) != NULL)
			{
				std::string function(buffer);

				if(strncmp(buffer, "Name,", 5) == 0)
				{
					function = function.substr(5, function.length() - 6);
					ImportData import_data(current_library, function, false);
					std::cout << import_data.toString() << "\n";
				}
				else if(strncmp(buffer, "Ordinal,", 8) == 0)
				{
					function = function.substr(8, function.length() - 9);
					ImportData import_data(current_library, function, true);
					std::cout << import_data.toString() << "\n";
				}
			}
		}
	}
	pclose(result);
}
