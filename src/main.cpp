#include <stdio.h>
#include <stdlib.h>
#include <iostream>
#include <fstream>
#include <string.h>
#include <vector>
#include "import_data.h"
#include "malware_definition.h"
#include "malware_definition_children/keylogger_definition.h"

std::vector<MalwareDefinition*> generateDefinitions()
{
	std::vector<MalwareDefinition*> definitions;
	
	definitions.insert(definitions.end(), new KeyloggerDefinition());

	return definitions;
}

void deleteDefinitionData(std::vector<ImportData*> definitions)
{
	for (std::vector<ImportData*>::iterator iter = definitions.begin(); iter != definitions.end(); iter++)
	{
		std::cout << (*iter)->toString() << "\n";
		delete *iter;
	}
}

int main(int argc, char **argv)
{
	std::vector<MalwareDefinition*> definitions = generateDefinitions();
	deleteDefinitionData(definitions.at(0)->imports_used);

	std::string in_file(argv[1]);

	std::string readpe_command = in_file;
	readpe_command = "readpe --format csv -i " + readpe_command;
	const char* c_str_readpe_command = readpe_command.c_str();

	FILE *result;
	char buffer[255];
	result = popen(c_str_readpe_command, "r");

	std::string current_library;

	while(fgets(buffer, 255, result) != NULL)
	{
		if(strncmp(buffer, "Library", 7) == 0)
		{
			if(fgets(buffer, 255, result) != NULL)
			{
				current_library = buffer;
				std::size_t end_pos = current_library.find(".") - 5;
				current_library = current_library.substr(5, end_pos);
			}
		}
		else if(strncmp(buffer, "Functions", 9) == 0)
		{
			continue;
		}
		else if(strncmp(buffer, "Function", 8) == 0)
		{
			if(fgets(buffer, 255, result) != NULL)
			{
				std::string function(buffer);

				if(strncmp(buffer, "Name,", 5) == 0)
				{
					function = function.substr(5, function.length() - 6);
					ImportData import_data(current_library, function, false);
					std::cout << import_data.toString() << "\n";
					//lookup
				}
				else if(strncmp(buffer, "Ordinal,", 8) == 0)
				{
					function = function.substr(8, function.length() - 9);
					ImportData import_data(current_library, function, true);
					std::cout << import_data.toString() << "\n";
					//lookup
				}
			}
		}
	}
	pclose(result);

	std::string pestr_command = in_file;
	pestr_command = "pestr " + pestr_command;
	const char* c_str_pestr_command = pestr_command.c_str();

	result = popen(c_str_pestr_command, "r");

	while(fgets(buffer, 255, result) != NULL)
	{
		//lookup
	}
}
